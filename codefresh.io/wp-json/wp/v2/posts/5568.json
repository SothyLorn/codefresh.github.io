{"id":5568,"date":"2017-11-28T00:27:04","date_gmt":"2017-11-28T00:27:04","guid":{"rendered":"https:\/\/codefresh.io\/?p=5568"},"modified":"2018-06-15T19:15:28","modified_gmt":"2018-06-15T19:15:28","slug":"single-use-daemonset-pattern-pre-pulling-images-kubernetes","status":"publish","type":"post","link":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/","title":{"rendered":"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes"},"content":{"rendered":"<h2>Speed up Kubernetes Pod Creation of Large Images<\/h2>\n<p>If you work with large Docker images (5Gbs), then you know that they can slow down pod creation. To speed up this whole process, I&#8217;ll show how to pre-pull images to Kubernetes using a DaemonSet, meaning that when a pod is scheduled to run on a node, the relevant Docker image will already be on that node instead of being pulled at the time of deployment. Again, this is useful in cases where the image is big, and pods are recreated often (for example in a scale out scenario).<\/p>\n<p>Of course, everything I share in this post is compatible with Codefresh. If you haven&#8217;t already tried Codefresh and created pipeline, you can <a href=\"https:\/\/codefresh.io\">create a free account<\/a>.<\/p>\n<h2>Docker in Docker<\/h2>\n<p>Creating a Docker container that does the docker pull command is pretty easy with &#8216;Docker in docker&#8217; container (aka &#8216;dind&#8217;) so we could easily create a pod that looks like:<\/p>\n<pre class=\"lang:default decode:true\">containers:\n- name: prepull \n   image: docker\n   command: [\"docker\", \"pull\", \"hello-world\"]\n   volumeMounts:\n     - name: docker\n       mountPath: \/var\/run\nvolumes:\n  - name: docker\n     hostPath:\n       path: \/var\/run<\/pre>\n<p>This pod attaches to the host&#8217;s docker daemon and will pull the image &#8216;hello-world&#8217;. That&#8217;s fine, but now we need to make sure this pod is being run at least once on every node in the cluster.<\/p>\n<h2>DaemonSet<\/h2>\n<p>That sounds like a good fit for a DaemonSet. This Kubernetes entity is suitable for infrastructure services that needs to run on all nodes. The usual use cases are log collection and monitoring agents. This sounds prefect for our case, but the issue with DaemonSet, is that it can only have a restartPolicy: Always. This means that Kubernetes will restart the pod infinitely which will constantly attempt to pull the image. It&#8217;s not a huge disaster because Docker will just detect that the image exists and will pass quickly, but still it doesn&#8217;t feel right.<\/p>\n<h3>DaemonSet single-use pattern<\/h3>\n<p>To work around this limitation, I did the following trick: I still used the same container to pull the image as explained before, but I designated it as an initContainer instead of regular container. This means it&#8217;ll run only once when the pod is scheduled, and after it&#8217;s done the regular container in the pod will run. I then used the &#8216;pause&#8217; container as the pod&#8217;s main container, this container practically does nothing, which is exactly what we want to do after we pulled the image on that node &#8211; keep the DaemonSet pod alive but take as little resources as possible. I guess you can call this pattern a workaround, but it&#8217;s a useful trick for scenarios like this.<\/p>\n<h3>Result<\/h3>\n<p>The end result is shared here: <a href=\"https:\/\/gist.github.com\/itaysk\/7bc3e56d69c4d72a549286d98fd557dd\">https:\/\/gist.github.com\/itaysk\/7bc3e56d69c4d72a549286d98fd557dd<\/a><\/p>\n<pre class=\"lang:default decode:true \">apiVersion: apps\/v1beta2\nkind: DaemonSet\nmetadata:\n  name: prepull\nspec:\n  selector:\n    matchLabels:\n      name: prepull \n  template:\n    metadata:\n      labels:\n        name: prepull \n    spec:\n      initContainers:\n      - name: prepull \n        image: docker\n        command: [\"docker\", \"pull\", \"hello-world\"]\n        volumeMounts:\n        - name: docker\n          mountPath: \/var\/run\n      volumes:\n      - name: docker\n        hostPath:\n          path: \/var\/run\n      containers:\n      - name: pause\n        image: gcr.io\/google_containers\/pause<\/pre>\n<p>You can just &#8216;kubectl create&#8217; it, and it will make sure your &#8216;hello-world&#8217; pod is pulled into every node in the cluster.<\/p>\n<p>New to Codefresh? <a href=\"https:\/\/codefresh.io\/codefresh-signup\/?utm_source=Blog&#038;utm_medium=Post&#038;utm_campaign=EKsB\">Create Your Free Account Today! <\/a><\/p>\n<input class=\"fooboxshare_post_id\" type=\"hidden\" value=\"5568\"\/>","protected":false},"excerpt":{"rendered":"<p>Speed up Kubernetes Pod Creation of Large Images If you work with large Docker images (5Gbs), then you know that they can slow down pod creation. To speed up this whole process, I&#8217;ll show how to pre-pull images to Kubernetes using a DaemonSet, meaning that when a pod is scheduled to run on a node, &hellip; <a href=\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/\">Read more<\/a><\/p>\n","protected":false},"author":125,"featured_media":4218,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[1657],"tags":[14,44,592],"yoast_head":"<!-- This site is optimized with the Yoast SEO Premium plugin v17.9 (Yoast SEO v18.4.1) - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes | Codefresh<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes\" \/>\n<meta property=\"og:description\" content=\"Speed up Kubernetes Pod Creation of Large Images If you work with large Docker images (5Gbs), then you know that they can slow down pod creation. To speed up this whole process, I&#8217;ll show how to pre-pull images to Kubernetes using a DaemonSet, meaning that when a pod is scheduled to run on a node, &hellip; Read more\" \/>\n<meta property=\"og:url\" content=\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/\" \/>\n<meta property=\"og:site_name\" content=\"Codefresh\" \/>\n<meta property=\"article:publisher\" content=\"https:\/\/www.facebook.com\/codefresh.io\" \/>\n<meta property=\"article:published_time\" content=\"2017-11-28T00:27:04+00:00\" \/>\n<meta property=\"article:modified_time\" content=\"2018-06-15T19:15:28+00:00\" \/>\n<meta property=\"og:image\" content=\"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png\" \/>\n\t<meta property=\"og:image:width\" content=\"366\" \/>\n\t<meta property=\"og:image:height\" content=\"354\" \/>\n\t<meta property=\"og:image:type\" content=\"image\/png\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<meta name=\"twitter:creator\" content=\"@codefresh\" \/>\n<meta name=\"twitter:site\" content=\"@codefresh\" \/>\n<meta name=\"twitter:label1\" content=\"Written by\" \/>\n\t<meta name=\"twitter:data1\" content=\"Contributor\" \/>\n\t<meta name=\"twitter:label2\" content=\"Est. reading time\" \/>\n\t<meta name=\"twitter:data2\" content=\"3 minutes\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"Organization\",\"@id\":\"https:\/\/codefresh.io\/#organization\",\"name\":\"Codefresh\",\"url\":\"https:\/\/codefresh.io\/\",\"sameAs\":[\"https:\/\/www.facebook.com\/codefresh.io\",\"https:\/\/www.linkedin.com\/company\/codefresh\",\"https:\/\/www.youtube.com\/channel\/UC9r94SY6BqN05kXPIHsDXPg\",\"https:\/\/twitter.com\/codefresh\"],\"logo\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/codefresh.io\/#logo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/codefresh.io\/wp-content\/uploads\/2022\/02\/Codefresh_Logo_Vertical_LightBkgd.png\",\"contentUrl\":\"https:\/\/codefresh.io\/wp-content\/uploads\/2022\/02\/Codefresh_Logo_Vertical_LightBkgd.png\",\"width\":800,\"height\":800,\"caption\":\"Codefresh\"},\"image\":{\"@id\":\"https:\/\/codefresh.io\/#logo\"}},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/codefresh.io\/#website\",\"url\":\"https:\/\/codefresh.io\/\",\"name\":\"Codefresh\",\"description\":\"\",\"publisher\":{\"@id\":\"https:\/\/codefresh.io\/#organization\"},\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/codefresh.io\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#primaryimage\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png\",\"contentUrl\":\"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png\",\"width\":366,\"height\":354},{\"@type\":\"WebPage\",\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#webpage\",\"url\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/\",\"name\":\"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes | Codefresh\",\"isPartOf\":{\"@id\":\"https:\/\/codefresh.io\/#website\"},\"primaryImageOfPage\":{\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#primaryimage\"},\"datePublished\":\"2017-11-28T00:27:04+00:00\",\"dateModified\":\"2018-06-15T19:15:28+00:00\",\"breadcrumb\":{\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#breadcrumb\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/\"]}]},{\"@type\":\"BreadcrumbList\",\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#breadcrumb\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"https:\/\/codefresh.io\/\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes\"}]},{\"@type\":\"Article\",\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#article\",\"isPartOf\":{\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#webpage\"},\"author\":{\"@id\":\"https:\/\/codefresh.io\/#\/schema\/person\/268e5c2e4740502fae6d803783a16c75\"},\"headline\":\"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes\",\"datePublished\":\"2017-11-28T00:27:04+00:00\",\"dateModified\":\"2018-06-15T19:15:28+00:00\",\"mainEntityOfPage\":{\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#webpage\"},\"wordCount\":473,\"commentCount\":3,\"publisher\":{\"@id\":\"https:\/\/codefresh.io\/#organization\"},\"image\":{\"@id\":\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#primaryimage\"},\"thumbnailUrl\":\"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png\",\"keywords\":[\"docker\",\"Kubernetes\",\"pods\"],\"articleSection\":[\"Kubernetes Tutorials\"],\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"CommentAction\",\"name\":\"Comment\",\"target\":[\"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#respond\"]}]},{\"@type\":\"Person\",\"@id\":\"https:\/\/codefresh.io\/#\/schema\/person\/268e5c2e4740502fae6d803783a16c75\",\"name\":\"Contributor\",\"image\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/codefresh.io\/#personlogo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/26bd6dd87bf70f0c1a44721c8b3abbbd?s=96&d=blank&r=g\",\"contentUrl\":\"https:\/\/secure.gravatar.com\/avatar\/26bd6dd87bf70f0c1a44721c8b3abbbd?s=96&d=blank&r=g\",\"caption\":\"Contributor\"},\"url\":\"https:\/\/codefresh.io\/author\/contributor\/\"}]}<\/script>\n<!-- \/ Yoast SEO Premium plugin. -->","yoast_head_json":{"title":"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes | Codefresh","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/","og_locale":"en_US","og_type":"article","og_title":"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes","og_description":"Speed up Kubernetes Pod Creation of Large Images If you work with large Docker images (5Gbs), then you know that they can slow down pod creation. To speed up this whole process, I&#8217;ll show how to pre-pull images to Kubernetes using a DaemonSet, meaning that when a pod is scheduled to run on a node, &hellip; Read more","og_url":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/","og_site_name":"Codefresh","article_publisher":"https:\/\/www.facebook.com\/codefresh.io","article_published_time":"2017-11-28T00:27:04+00:00","article_modified_time":"2018-06-15T19:15:28+00:00","og_image":[{"width":366,"height":354,"url":"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png","type":"image\/png"}],"twitter_card":"summary_large_image","twitter_creator":"@codefresh","twitter_site":"@codefresh","twitter_misc":{"Written by":"Contributor","Est. reading time":"3 minutes"},"schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"Organization","@id":"https:\/\/codefresh.io\/#organization","name":"Codefresh","url":"https:\/\/codefresh.io\/","sameAs":["https:\/\/www.facebook.com\/codefresh.io","https:\/\/www.linkedin.com\/company\/codefresh","https:\/\/www.youtube.com\/channel\/UC9r94SY6BqN05kXPIHsDXPg","https:\/\/twitter.com\/codefresh"],"logo":{"@type":"ImageObject","@id":"https:\/\/codefresh.io\/#logo","inLanguage":"en-US","url":"https:\/\/codefresh.io\/wp-content\/uploads\/2022\/02\/Codefresh_Logo_Vertical_LightBkgd.png","contentUrl":"https:\/\/codefresh.io\/wp-content\/uploads\/2022\/02\/Codefresh_Logo_Vertical_LightBkgd.png","width":800,"height":800,"caption":"Codefresh"},"image":{"@id":"https:\/\/codefresh.io\/#logo"}},{"@type":"WebSite","@id":"https:\/\/codefresh.io\/#website","url":"https:\/\/codefresh.io\/","name":"Codefresh","description":"","publisher":{"@id":"https:\/\/codefresh.io\/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/codefresh.io\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#primaryimage","inLanguage":"en-US","url":"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png","contentUrl":"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png","width":366,"height":354},{"@type":"WebPage","@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#webpage","url":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/","name":"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes | Codefresh","isPartOf":{"@id":"https:\/\/codefresh.io\/#website"},"primaryImageOfPage":{"@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#primaryimage"},"datePublished":"2017-11-28T00:27:04+00:00","dateModified":"2018-06-15T19:15:28+00:00","breadcrumb":{"@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/"]}]},{"@type":"BreadcrumbList","@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/codefresh.io\/"},{"@type":"ListItem","position":2,"name":"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes"}]},{"@type":"Article","@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#article","isPartOf":{"@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#webpage"},"author":{"@id":"https:\/\/codefresh.io\/#\/schema\/person\/268e5c2e4740502fae6d803783a16c75"},"headline":"The Single-use Daemonset Pattern and Pre-pulling Images in Kubernetes","datePublished":"2017-11-28T00:27:04+00:00","dateModified":"2018-06-15T19:15:28+00:00","mainEntityOfPage":{"@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#webpage"},"wordCount":473,"commentCount":3,"publisher":{"@id":"https:\/\/codefresh.io\/#organization"},"image":{"@id":"https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#primaryimage"},"thumbnailUrl":"https:\/\/codefresh.io\/wp-content\/uploads\/2017\/06\/image-management-icon@3x.png","keywords":["docker","Kubernetes","pods"],"articleSection":["Kubernetes Tutorials"],"inLanguage":"en-US","potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https:\/\/codefresh.io\/kubernetes-tutorial\/single-use-daemonset-pattern-pre-pulling-images-kubernetes\/#respond"]}]},{"@type":"Person","@id":"https:\/\/codefresh.io\/#\/schema\/person\/268e5c2e4740502fae6d803783a16c75","name":"Contributor","image":{"@type":"ImageObject","@id":"https:\/\/codefresh.io\/#personlogo","inLanguage":"en-US","url":"https:\/\/secure.gravatar.com\/avatar\/26bd6dd87bf70f0c1a44721c8b3abbbd?s=96&d=blank&r=g","contentUrl":"https:\/\/secure.gravatar.com\/avatar\/26bd6dd87bf70f0c1a44721c8b3abbbd?s=96&d=blank&r=g","caption":"Contributor"},"url":"https:\/\/codefresh.io\/author\/contributor\/"}]}},"acf":[],"_links":{"self":[{"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/posts\/5568"}],"collection":[{"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/users\/125"}],"replies":[{"embeddable":true,"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/comments?post=5568"}],"version-history":[{"count":0,"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/posts\/5568\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/media\/4218"}],"wp:attachment":[{"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/media?parent=5568"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/categories?post=5568"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/codefresh.io\/wp-json\/wp\/v2\/tags?post=5568"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}